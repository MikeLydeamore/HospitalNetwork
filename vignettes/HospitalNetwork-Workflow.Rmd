---
title: "HospitalNetwork-Workflow"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{HospitalNetwork-Workflow}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

## Context

This R package contains functions to help interested researchers construct networks from data on movement of individual between locations. Although this package was initially developed in the context of networks of healthcare facilities, where the links represent transfer of patients between facilities, the process can be generalized to the movement of any type of subject between any type of locations.

Formally, a network is composed of *nodes* which may or may not be connected by *edges* (or links). In the context of this package, the nodes are the facilities, and the links represent connections between facilities. Although the definition of a node is straightforward, one can define a *connection* between two facilities in different ways. This package allows to construct a network using various definition of a connection, which are discussed in detail here [ref].

In terms of data structure, a common way of representing a network is with a simple $n*n$ matrix (often called adjacency matrix, or contact matrix). The rows and columns contain the nodes (which appear once in each), and each cell contains the information on whether or not the two nodes are connected.


```{r adjacency-matrix, echo = F, dev = 'svg', results = 'asis'}
data = c(0,0,602,0,339,687,0,0,0,0,373,1294,0,718,86,296,263,0,0,35,0,598,0,0,0)
mat = matrix(data, nrow = 5, ncol = 5)
colnames(mat) = LETTERS[1:5]
rownames(mat) = colnames(mat)
pander::pandoc.table(mat, caption = 'Example of a matrix representation of a 5-nodes network. By convention, the rows contain the facilities of origin, and the columns contain the target facilities. Each cell contains the number of subjects transfered.', )
```

At its core, the purpose of this package is to compute the contact matrix from raw data on movement between facilities. Additionally, this package provides the researcher with various tools to analyse and visualize the constructed network.


## Data

The package requires a minimal set of information in order to build a network of facilities. This set of data is describe under the section "Required data". To proceed to further analysis, the package can use additional information in case they are available. These informations are listed under the section "Optional informations". 

### Required data

The minimal data needed to construct the network is a simple table with four variables:

* **subject ID:** an identifier unique to each subject
* **facility ID:** an identifier unique to each facility
* **admission date:** the date of admission of the subject in the facility
* **discharge date:** the date of discharge of the subject from the facility

Therefore, each row must correspond to a unique stay of a subject in a facility. Stays are not allowed to overlap (see [Data management](#datamanagement)).

```{r data_example}
library(HospitalNetwork)
data = create_fake_patientDB(n_patients = 3, n_hospitals = 3)
data
```

### Optional data (in the same database)

TODO

| Item          | Variable name     | Description                 |
|---------------|:-----------------:|-----------------------------|
|Mode of entry | entry | a variable indicating whether the patient arrived from home (0), or from a hospital (1) |
|Mode of discharge | discharge | a variable indicating whether the patient is discharged back home (0), or to a hospital (1) |
|Patient residential postcode | postcodeÂ | a variable indicating the postalcode of the patient residency |
|Wards visited by the patient | ward | a single type of ward predominantly visited by the patient, coded as 1 for ICU or acute care and 0 for others |

### Optional data (in a separate database)

TODO

|Item| Variable name |Description|
|----|:-------------:|-----------|
|Hospital localization| localisation | GPS coordinates of the hospital|
|Hospital capacity | capacity | the number of beds available in the hospital|
|Hospital type | type | the type of hospital (ECDC level definitions)|

## Workflow

### Diagnostic tests {#diag}

Several diagnostic functions are provided to check for possible errors in the database. These functions also offer the possibily to automatically correct the issues it may have found in the database. However, since we cannot guarantee having checked for every possible issue, we encourage you to ensure the data is in the correct format, and is free of errors, prior to run the diagnostic functions. By default, the diagnostic functions will not modify the database, but return informative messages on the issues found. If you wish the diagnostic functions to try to autocorrect the database, we recommend that you carefully check the result afterwards. 

#### Requierements

The requierements to pass the diagnostic tests are the following:

* the database must be of class ```data.frame``` or ```data.table```. The functions are implemented in the ```data.table``` framework, so if a ```data.frame``` is provided, it will be converted to a ```data.table```.

* the database must have at least four columms. By default the column names must be: ```c("pID", "hID", "Adate", "Ddate"```. Although we recommend using these column names, it is possible to use different names by providing them as arguments.

* columns ```"pID"``` and ```"hID"``` must be of type ```character```.

* dates are handled using functions from the ```lubridate``` package. They should be ```POSIXct date-time objects```. If they are provided as character strings, the diagnostic functions will try to parse them to date-time objects using ```lubridate``` functions (see [Data management](#datamanagement)).

* stays should not overlap (see [Data management](#datamanagement) for more details).

#### Data management {#datamanagement}

TODO

##The *HospiNet* object

*HospiNet* is an S3 object containing the hospital matrix as well as specific informations regarding the network. We have developped a *summary* and a *print* method for this object. 
The informations contained in an *HospiNet* objects are: 

* *n_hospitals*, the number of hospitals in the network,
* *n_patients*, the number of patients in the network,
* *n_movements*, the number direct or indirect (depending on the window size) transfers,
* *window_threshold*, the size of the movement window in days (0 for direct transfers between hospitals),
* *hist_degrees*, *\_in*, *\_out*, are named vectors containing the number of nodes for each degree, indegree, or outdregree,
* ...


## Using the package

```{r setup, eval = F}
library(HospitalNetwork)

mydbmed = create_fake_patientDB(n_patients = 100, n_hospital = 10)
hn = hospinet_from_patient_database(base = mydbmed, noloops = FALSE)
hn
plot(hn)
plot(hn, type = "degree")
plot(hn , type = "clustered_matrix")


mydb = create_fake_patientDB_clustered(n_patients = 10000, n_hospital = 500, n_clusters = 5)
hn = hospinet_from_patient_database(base = mydb, noloops = FALSE)
hn
plot(hn)
plot(hn, type = "degree")
plot(hn , type = "clustered_matrix")
```


